module.exports=[48877,e=>{"use strict";var t=e.i(21347),a=e.i(4483),r=e.i(42707),n=e.i(7157),o=e.i(57085),i=e.i(42638),s=e.i(28123),d=e.i(73873),c=e.i(36011),u=e.i(2538),l=e.i(16591),p=e.i(24432),_=e.i(72920),E=e.i(32160),v=e.i(89104),R=e.i(13303),m=e.i(93695);e.i(54677);var f=e.i(77279),h=e.i(44747),T=e.i(62294),N=e.i(58090),O=e.i(77087),S=e.i(87715);async function w(){try{await (0,S.requirePermission)("ventas.ver");let e=await (0,T.query)(`SELECT v.*, 
              c.nombre as cliente_nombre,
              u.nombre as vendedor_nombre,
              u.apellido as vendedor_apellido
       FROM ventas v
       LEFT JOIN clientes c ON v.cliente_id = c.id
       LEFT JOIN usuarios u ON v.usuario_id = u.id
       ORDER BY v.fecha_venta DESC
       LIMIT 100`);return h.NextResponse.json({success:!0,data:e})}catch(e){if(console.error("Error al obtener ventas:",e),e.message?.includes("iniciar sesión"))return h.NextResponse.json({error:e.message},{status:401});return h.NextResponse.json({error:e.message||"Error al obtener ventas"},{status:e.message?.includes("permiso")?403:500})}}async function g(e){try{await (0,S.requirePermission)("ventas.crear");let t=await (0,N.getServerSession)(O.authOptions);if(!t?.user)return h.NextResponse.json({error:"Usuario no autenticado"},{status:401});let{cliente_id:a,tipo_venta:r,metodo_pago:n,productos:o,subtotal:i,iva:s,descuento:d,total:c,descuento_id:u,efectivo_recibido:l,cambio:p,pago_mixto:_,abono:E,referencia_transferencia:v}=await e.json();if(!o||0===o.length)return h.NextResponse.json({error:"Debe incluir al menos un producto"},{status:400});if(!c||c<=0)return h.NextResponse.json({error:"El total debe ser mayor a 0"},{status:400});if(!await (0,T.queryOne)("SELECT id FROM sesiones_caja WHERE estado = 'abierta' LIMIT 1"))return h.NextResponse.json({error:"La caja está cerrada. Debe abrir la caja antes de registrar ventas."},{status:400});let R=t.user.id,m=new Date,f=m.getFullYear(),w=String(m.getMonth()+1).padStart(2,"0"),g=String(m.getDate()).padStart(2,"0"),b=await (0,T.queryOne)(`SELECT numero_venta FROM ventas 
       WHERE DATE(fecha_venta) = CURDATE() 
       ORDER BY id DESC LIMIT 1`),I=1;if(b&&b.numero_venta){let e=b.numero_venta.match(/-(\d+)$/);e&&(I=parseInt(e[1])+1)}let C=`VEN-${f}${w}${g}-${String(I).padStart(4,"0")}`,y=await (0,T.queryOne)("SELECT id FROM cajas WHERE estado = 'activa' LIMIT 1"),A=y?.id||null;for(let e of o){let t=await (0,T.queryOne)("SELECT id, nombre, stock_actual FROM productos WHERE id = ?",[e.producto_id]);if(!t)return h.NextResponse.json({error:`Producto con ID ${e.producto_id} no encontrado`},{status:400});if(t.stock_actual<e.cantidad)return h.NextResponse.json({error:`Stock insuficiente para ${t.nombre}. Disponible: ${t.stock_actual}, Requerido: ${e.cantidad}`},{status:400})}let x=(await (0,T.query)(`INSERT INTO ventas (
        numero_venta, cliente_id, fecha_venta, subtotal, iva, descuento, total,
        estado, descuento_id, usuario_id, caja_id, tipo_venta, metodo_pago,
        efectivo_recibido, cambio, referencia_transferencia
      ) VALUES (?, ?, NOW(), ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)`,[C,a||null,i||0,s||0,d||0,c,"credito"===r?"credito":"completada",u||null,R,A,r||"contado",n||"efectivo",l||null,p||null,v||null])).insertId;for(let e of("mixto"===n&&_&&await (0,T.query)(`INSERT INTO pagos_mixtos_ventas (
          venta_id, monto_efectivo, monto_transferencia, referencia_transferencia
        ) VALUES (?, ?, ?, ?)`,[x,_.efectivo||0,_.transferencia||0,v||null]),o)){let t=await (0,T.queryOne)("SELECT stock_actual FROM productos WHERE id = ?",[e.producto_id]),a=t?.stock_actual||0,r=a-e.cantidad;await (0,T.query)(`INSERT INTO detalle_ventas (venta_id, producto_id, cantidad, precio_unitario, subtotal)
         VALUES (?, ?, ?, ?, ?)`,[x,e.producto_id,e.cantidad,e.precio_unitario,e.cantidad*e.precio_unitario]),await (0,T.query)(`UPDATE productos 
         SET stock_actual = stock_actual - ? 
         WHERE id = ?`,[e.cantidad,e.producto_id]),await (0,T.query)(`INSERT INTO movimientos_inventario (
          producto_id, tipo_movimiento, cantidad, stock_anterior, 
          stock_nuevo, motivo, venta_id, usuario_id, fecha_movimiento
        ) VALUES (?, 'salida_venta', ?, ?, ?, 'Venta', ?, ?, NOW())`,[e.producto_id,-e.cantidad,a,r,x,R])}if("credito"===r&&a){let e=(await (0,T.query)(`INSERT INTO cuentas_por_cobrar (
          cliente_id, venta_id, monto_total, saldo_pendiente, 
          fecha_vencimiento, estado
        ) VALUES (?, ?, ?, ?, DATE_ADD(NOW(), INTERVAL 30 DAY), 'pendiente')`,[a,x,c,c])).insertId;if(E&&E.monto>0){let t=(await (0,T.query)(`INSERT INTO abonos (
            cuenta_por_cobrar_id, monto, metodo_pago, usuario_id, notas, referencia_transferencia
          ) VALUES (?, ?, ?, ?, 'Abono inicial', ?)`,[e,E.monto,E.metodo,R,E.referenciaTransferencia||null])).insertId;"mixto"===E.metodo&&await (0,T.query)(`INSERT INTO pagos_mixtos_abonos (
              abono_id, monto_efectivo, monto_transferencia, referencia_transferencia
            ) VALUES (?, ?, ?, ?)`,[t,E.montoEfectivo||0,E.montoTransferencia||0,E.referenciaTransferencia||null])}await (0,T.query)(`UPDATE clientes 
         SET saldo_pendiente = saldo_pendiente + ?,
             saldo_actual = saldo_actual + ?
         WHERE id = ?`,[c,c,a])}if(A&&"contado"===r){let e=await (0,T.queryOne)(`SELECT id FROM sesiones_caja 
         WHERE caja_id = ? AND estado = 'abierta' AND usuario_id = ?
         ORDER BY fecha_apertura DESC LIMIT 1`,[A,R]);e&&await (0,T.query)(`INSERT INTO movimientos_caja (
            sesion_caja_id, tipo_movimiento, monto, venta_id, 
            usuario_id, fecha_movimiento
          ) VALUES (?, 'venta', ?, ?, ?, NOW())`,[e.id,c,x,R])}let q=await (0,T.queryOne)(`SELECT v.*, 
              c.nombre as cliente_nombre,
              c.identificacion as cliente_identificacion,
              c.telefono as cliente_telefono,
              c.direccion as cliente_direccion,
              u.nombre as vendedor_nombre,
              u.apellido as vendedor_apellido,
              cpc.monto_total as credito_monto_total,
              cpc.saldo_pendiente as credito_saldo_pendiente,
              (SELECT COALESCE(SUM(a.monto), 0) 
               FROM abonos a 
               WHERE a.cuenta_por_cobrar_id = cpc.id) as credito_abono_total
       FROM ventas v
       LEFT JOIN clientes c ON v.cliente_id = c.id
       LEFT JOIN usuarios u ON v.usuario_id = u.id
       LEFT JOIN cuentas_por_cobrar cpc ON v.id = cpc.venta_id
       WHERE v.id = ?`,[x]);return q.detalles=await (0,T.query)(`SELECT dv.*, 
              p.nombre as producto_nombre,
              p.sku,
              p.codigo_barras
       FROM detalle_ventas dv
       INNER JOIN productos p ON dv.producto_id = p.id
       WHERE dv.venta_id = ?`,[x]),h.NextResponse.json({success:!0,data:q,message:"Venta registrada exitosamente"},{status:201})}catch(e){return console.error("Error al crear venta:",e),h.NextResponse.json({error:e.message||"Error al crear venta"},{status:e.message?.includes("permiso")?403:500})}}e.s(["GET",()=>w,"POST",()=>g],57870);var b=e.i(57870);let I=new t.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/ventas/route",pathname:"/api/ventas",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/app/api/ventas/route.ts",nextConfigOutput:"",userland:b}),{workAsyncStorage:C,workUnitAsyncStorage:y,serverHooks:A}=I;function x(){return(0,r.patchFetch)({workAsyncStorage:C,workUnitAsyncStorage:y})}async function q(e,t,r){I.isDev&&(0,n.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let h="/api/ventas/route";h=h.replace(/\/index$/,"")||"/";let T=await I.prepare(e,t,{srcPage:h,multiZoneDraftMode:!1});if(!T)return t.statusCode=400,t.end("Bad Request"),null==r.waitUntil||r.waitUntil.call(r,Promise.resolve()),null;let{buildId:N,params:O,nextConfig:S,parsedUrl:w,isDraftMode:g,prerenderManifest:b,routerServerContext:C,isOnDemandRevalidate:y,revalidateOnlyGenerated:A,resolvedPathname:x,clientReferenceManifest:q,serverActionsManifest:L}=T,D=(0,d.normalizeAppPath)(h),M=!!(b.dynamicRoutes[D]||b.routes[x]),P=async()=>((null==C?void 0:C.render404)?await C.render404(e,t,w,!1):t.end("This page could not be found"),null);if(M&&!g){let e=!!b.routes[x],t=b.dynamicRoutes[D];if(t&&!1===t.fallback&&!e){if(S.experimental.adapterPath)return await P();throw new m.NoFallbackError}}let U=null;!M||I.isDev||g||(U="/index"===(U=x)?"/":U);let j=!0===I.isDev||!M,H=M&&!j;L&&q&&(0,i.setReferenceManifestsSingleton)({page:h,clientReferenceManifest:q,serverActionsManifest:L,serverModuleMap:(0,s.createServerModuleMap)({serverActionsManifest:L})});let k=e.method||"GET",F=(0,o.getTracer)(),$=F.getActiveScopeSpan(),W={params:O,prerenderManifest:b,renderOpts:{experimental:{authInterrupts:!!S.experimental.authInterrupts},cacheComponents:!!S.cacheComponents,supportsDynamicResponse:j,incrementalCache:(0,n.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:S.cacheLife,waitUntil:r.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,a,r)=>I.onRequestError(e,t,r,C)},sharedContext:{buildId:N}},V=new c.NodeNextRequest(e),B=new c.NodeNextResponse(t),K=u.NextRequestAdapter.fromNodeNextRequest(V,(0,u.signalFromNodeResponse)(t));try{let i=async e=>I.handle(K,W).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let a=F.getRootSpanAttributes();if(!a)return;if(a.get("next.span_type")!==l.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${a.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let r=a.get("next.route");if(r){let t=`${k} ${r}`;e.setAttributes({"next.route":r,"http.route":r,"next.span_name":t}),e.updateName(t)}else e.updateName(`${k} ${h}`)}),s=!!(0,n.getRequestMeta)(e,"minimalMode"),d=async n=>{var o,d;let c=async({previousCacheEntry:a})=>{try{if(!s&&y&&A&&!a)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let o=await i(n);e.fetchMetrics=W.renderOpts.fetchMetrics;let d=W.renderOpts.pendingWaitUntil;d&&r.waitUntil&&(r.waitUntil(d),d=void 0);let c=W.renderOpts.collectedTags;if(!M)return await (0,_.sendResponse)(V,B,o,W.renderOpts.pendingWaitUntil),null;{let e=await o.blob(),t=(0,E.toNodeOutgoingHttpHeaders)(o.headers);c&&(t[R.NEXT_CACHE_TAGS_HEADER]=c),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let a=void 0!==W.renderOpts.collectedRevalidate&&!(W.renderOpts.collectedRevalidate>=R.INFINITE_CACHE)&&W.renderOpts.collectedRevalidate,r=void 0===W.renderOpts.collectedExpire||W.renderOpts.collectedExpire>=R.INFINITE_CACHE?void 0:W.renderOpts.collectedExpire;return{value:{kind:f.CachedRouteKind.APP_ROUTE,status:o.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:a,expire:r}}}}catch(t){throw(null==a?void 0:a.isStale)&&await I.onRequestError(e,t,{routerKind:"App Router",routePath:h,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:H,isOnDemandRevalidate:y})},C),t}},u=await I.handleResponse({req:e,nextConfig:S,cacheKey:U,routeKind:a.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:b,isRoutePPREnabled:!1,isOnDemandRevalidate:y,revalidateOnlyGenerated:A,responseGenerator:c,waitUntil:r.waitUntil,isMinimalMode:s});if(!M)return null;if((null==u||null==(o=u.value)?void 0:o.kind)!==f.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==u||null==(d=u.value)?void 0:d.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});s||t.setHeader("x-nextjs-cache",y?"REVALIDATED":u.isMiss?"MISS":u.isStale?"STALE":"HIT"),g&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let l=(0,E.fromNodeOutgoingHttpHeaders)(u.value.headers);return s&&M||l.delete(R.NEXT_CACHE_TAGS_HEADER),!u.cacheControl||t.getHeader("Cache-Control")||l.get("Cache-Control")||l.set("Cache-Control",(0,v.getCacheControlHeader)(u.cacheControl)),await (0,_.sendResponse)(V,B,new Response(u.value.body,{headers:l,status:u.value.status||200})),null};$?await d($):await F.withPropagatedContext(e.headers,()=>F.trace(l.BaseServerSpan.handleRequest,{spanName:`${k} ${h}`,kind:o.SpanKind.SERVER,attributes:{"http.method":k,"http.target":e.url}},d))}catch(t){if(t instanceof m.NoFallbackError||await I.onRequestError(e,t,{routerKind:"App Router",routePath:D,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:H,isOnDemandRevalidate:y})}),M)throw t;return await (0,_.sendResponse)(V,B,new Response(null,{status:500})),null}}e.s(["handler",()=>q,"patchFetch",()=>x,"routeModule",()=>I,"serverHooks",()=>A,"workAsyncStorage",()=>C,"workUnitAsyncStorage",()=>y],48877)}];

//# sourceMappingURL=1dff6_next_dist_esm_build_templates_app-route_9d94cff4.js.map