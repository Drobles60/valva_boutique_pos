{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 118, "column": 0}, "map": {"version":3,"sources":["file:///D:/Documents/proyectos/valva_boutique_pos/lib/db.ts"],"sourcesContent":["import mysql from 'mysql2/promise';\r\n\r\n// Configuración de la conexión a MySQL\r\nconst dbConfig = {\r\n  host: process.env.DB_HOST || 'localhost',\r\n  port: parseInt(process.env.DB_PORT || '3306'),\r\n  user: process.env.DB_USER || 'root',\r\n  password: process.env.DB_PASSWORD || 'Luciana1510@',\r\n  database: process.env.DB_NAME || 'valva_boutique',\r\n  waitForConnections: true,\r\n  connectionLimit: 10,\r\n  queueLimit: 0,\r\n  enableKeepAlive: true,\r\n  keepAliveInitialDelay: 0,\r\n};\r\n\r\n// Crear el pool de conexiones\r\nlet pool: mysql.Pool;\r\n\r\nexport function getPool(): mysql.Pool {\r\n  if (!pool) {\r\n    pool = mysql.createPool(dbConfig);\r\n  }\r\n  return pool;\r\n}\r\n\r\n// Función helper para ejecutar queries\r\nexport async function query<T = any>(\r\n  sql: string,\r\n  params?: any[]\r\n): Promise<T> {\r\n  const connection = await getPool().getConnection();\r\n  try {\r\n    const [results] = await connection.execute(sql, params);\r\n    return results as T;\r\n  } finally {\r\n    connection.release();\r\n  }\r\n}\r\n\r\n// Función helper para ejecutar queries con múltiples resultados\r\nexport async function queryMultiple<T = any>(\r\n  sql: string,\r\n  params?: any[]\r\n): Promise<T[]> {\r\n  const connection = await getPool().getConnection();\r\n  try {\r\n    const [results] = await connection.query(sql, params);\r\n    return results as T[];\r\n  } finally {\r\n    connection.release();\r\n  }\r\n}\r\n\r\n// Función para obtener una sola fila\r\nexport async function queryOne<T = any>(\r\n  sql: string,\r\n  params?: any[]\r\n): Promise<T | null> {\r\n  const results = await query<T[]>(sql, params);\r\n  return results.length > 0 ? results[0] : null;\r\n}\r\n\r\n// Función para ejecutar transacciones\r\nexport async function transaction<T>(\r\n  callback: (connection: mysql.PoolConnection) => Promise<T>\r\n): Promise<T> {\r\n  const connection = await getPool().getConnection();\r\n  try {\r\n    await connection.beginTransaction();\r\n    const result = await callback(connection);\r\n    await connection.commit();\r\n    return result;\r\n  } catch (error) {\r\n    await connection.rollback();\r\n    throw error;\r\n  } finally {\r\n    connection.release();\r\n  }\r\n}\r\n\r\n// Exportar tipos útiles\r\nexport type { PoolConnection, RowDataPacket, ResultSetHeader } from 'mysql2/promise';\r\n\r\n// Función para cerrar el pool (útil para testing)\r\nexport async function closePool(): Promise<void> {\r\n  if (pool) {\r\n    await pool.end();\r\n  }\r\n}\r\n\r\n// Función para verificar la conexión\r\nexport async function checkConnection(): Promise<boolean> {\r\n  try {\r\n    const connection = await getPool().getConnection();\r\n    await connection.ping();\r\n    connection.release();\r\n    return true;\r\n  } catch (error) {\r\n    console.error('Error al conectar con la base de datos:', error);\r\n    return false;\r\n  }\r\n}\r\n"],"names":[],"mappings":";;;;;;;;;;;;;;;;AAAA;;AAEA,uCAAuC;AACvC,MAAM,WAAW;IACf,MAAM,QAAQ,GAAG,CAAC,OAAO,IAAI;IAC7B,MAAM,SAAS,QAAQ,GAAG,CAAC,OAAO,IAAI;IACtC,MAAM,QAAQ,GAAG,CAAC,OAAO,IAAI;IAC7B,UAAU,QAAQ,GAAG,CAAC,WAAW,IAAI;IACrC,UAAU,QAAQ,GAAG,CAAC,OAAO,IAAI;IACjC,oBAAoB;IACpB,iBAAiB;IACjB,YAAY;IACZ,iBAAiB;IACjB,uBAAuB;AACzB;AAEA,8BAA8B;AAC9B,IAAI;AAEG,SAAS;IACd,IAAI,CAAC,MAAM;QACT,OAAO,kMAAK,CAAC,UAAU,CAAC;IAC1B;IACA,OAAO;AACT;AAGO,eAAe,MACpB,GAAW,EACX,MAAc;IAEd,MAAM,aAAa,MAAM,UAAU,aAAa;IAChD,IAAI;QACF,MAAM,CAAC,QAAQ,GAAG,MAAM,WAAW,OAAO,CAAC,KAAK;QAChD,OAAO;IACT,SAAU;QACR,WAAW,OAAO;IACpB;AACF;AAGO,eAAe,cACpB,GAAW,EACX,MAAc;IAEd,MAAM,aAAa,MAAM,UAAU,aAAa;IAChD,IAAI;QACF,MAAM,CAAC,QAAQ,GAAG,MAAM,WAAW,KAAK,CAAC,KAAK;QAC9C,OAAO;IACT,SAAU;QACR,WAAW,OAAO;IACpB;AACF;AAGO,eAAe,SACpB,GAAW,EACX,MAAc;IAEd,MAAM,UAAU,MAAM,MAAW,KAAK;IACtC,OAAO,QAAQ,MAAM,GAAG,IAAI,OAAO,CAAC,EAAE,GAAG;AAC3C;AAGO,eAAe,YACpB,QAA0D;IAE1D,MAAM,aAAa,MAAM,UAAU,aAAa;IAChD,IAAI;QACF,MAAM,WAAW,gBAAgB;QACjC,MAAM,SAAS,MAAM,SAAS;QAC9B,MAAM,WAAW,MAAM;QACvB,OAAO;IACT,EAAE,OAAO,OAAO;QACd,MAAM,WAAW,QAAQ;QACzB,MAAM;IACR,SAAU;QACR,WAAW,OAAO;IACpB;AACF;AAMO,eAAe;IACpB,IAAI,MAAM;QACR,MAAM,KAAK,GAAG;IAChB;AACF;AAGO,eAAe;IACpB,IAAI;QACF,MAAM,aAAa,MAAM,UAAU,aAAa;QAChD,MAAM,WAAW,IAAI;QACrB,WAAW,OAAO;QAClB,OAAO;IACT,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,2CAA2C;QACzD,OAAO;IACT;AACF"}},
    {"offset": {"line": 213, "column": 0}, "map": {"version":3,"sources":["file:///D:/Documents/proyectos/valva_boutique_pos/app/api/compras/%5Bid%5D/route.ts"],"sourcesContent":["// @ts-nocheck\r\nimport { NextRequest, NextResponse } from 'next/server'\r\nimport { query } from '@/lib/db'\r\n\r\n// GET: obtener compra con su detalle\r\nexport async function GET(request: NextRequest, { params }: { params: Promise<{ id: string }> }) {\r\n    try {\r\n        const { id } = await params\r\n        const [compra] = await query<any[]>(\r\n            `SELECT c.*, p.razon_social AS proveedor_nombre, u.nombre AS usuario_nombre\r\n       FROM compras c\r\n       LEFT JOIN proveedores p ON c.proveedor_id = p.id\r\n       LEFT JOIN usuarios    u ON c.usuario_id   = u.id\r\n       WHERE c.id = ?`, [id]\r\n        )\r\n        if (!compra) return NextResponse.json({ success: false, error: 'Compra no encontrada' }, { status: 404 })\r\n\r\n        const detalle = await query<any[]>(\r\n            `SELECT cd.*, pr.nombre AS producto_nombre, pr.sku,\r\n              t.valor AS talla_valor, pr.color,\r\n              tp.nombre AS tipo_prenda_nombre\r\n       FROM compra_detalle cd\r\n       INNER JOIN productos    pr ON cd.producto_id = pr.id\r\n       LEFT JOIN  tallas        t ON pr.talla_id    = t.id\r\n       LEFT JOIN  tipos_prenda tp ON pr.tipo_prenda_id = tp.id\r\n       WHERE cd.compra_id = ?\r\n       ORDER BY cd.id`, [id]\r\n        )\r\n\r\n        return NextResponse.json({ success: true, data: { ...compra, detalle } })\r\n    } catch (error: any) {\r\n        return NextResponse.json({ success: false, error: error.message }, { status: 500 })\r\n    }\r\n}\r\n\r\n// PUT: actualizar compra borrador\r\nexport async function PUT(request: NextRequest, { params }: { params: Promise<{ id: string }> }) {\r\n    try {\r\n        const { id } = await params\r\n        const body = await request.json()\r\n        const {\r\n            proveedor_id, factura_numero, fecha, fecha_vencimiento,\r\n            tipo_pago, observaciones, usuario_id, items = [], otros_costos = 0, abono_inicial = 0\r\n        } = body\r\n\r\n        // Verificar estado\r\n        const [comp] = await query<any[]>('SELECT estado FROM compras WHERE id=?', [id])\r\n        if (!comp) return NextResponse.json({ success: false, error: 'No encontrada' }, { status: 404 })\r\n        if (comp.estado === 'confirmada') return NextResponse.json({ success: false, error: 'No se puede editar una compra confirmada' }, { status: 400 })\r\n\r\n        // Calcular totales\r\n        let subtotal = 0, descuento_total = 0, iva_total = 0\r\n        const itemsCalc = items.map((it: any) => {\r\n            const sub = Number(it.cantidad) * Number(it.costo_unitario)\r\n            const desc = sub * (Number(it.descuento_pct) / 100)\r\n            const base = sub - desc\r\n            const iva = base * (Number(it.iva_pct) / 100)\r\n            subtotal += sub; descuento_total += desc; iva_total += iva\r\n            return { ...it, subtotal: sub.toFixed(2), total: (base + iva).toFixed(2) }\r\n        })\r\n        const total = subtotal - descuento_total + iva_total + Number(otros_costos)\r\n\r\n        await query(\r\n            `UPDATE compras SET proveedor_id=?, factura_numero=?, fecha=?, fecha_vencimiento=?, tipo_pago=?,\r\n       subtotal=?, descuento_total=?, iva_total=?, otros_costos=?, total=?, abono_inicial=?, usuario_id=?, observaciones=?\r\n       WHERE id=?`,\r\n            [proveedor_id, factura_numero || null, fecha, fecha_vencimiento || null, tipo_pago || 'contado',\r\n                subtotal.toFixed(2), descuento_total.toFixed(2), iva_total.toFixed(2),\r\n                Number(otros_costos).toFixed(2), total.toFixed(2), Number(abono_inicial).toFixed(2),\r\n                usuario_id || null, observaciones || null, id]\r\n        )\r\n\r\n        // Reemplazar detalle\r\n        await query('DELETE FROM compra_detalle WHERE compra_id=?', [id])\r\n        for (const it of itemsCalc) {\r\n            await query(\r\n                `INSERT INTO compra_detalle (compra_id, producto_id, cantidad, costo_unitario, descuento_pct, iva_pct, subtotal, total)\r\n         VALUES (?,?,?,?,?,?,?,?)`,\r\n                [id, it.producto_id, it.cantidad, it.costo_unitario, it.descuento_pct || 0, it.iva_pct || 0, it.subtotal, it.total]\r\n            )\r\n        }\r\n\r\n        return NextResponse.json({ success: true })\r\n    } catch (error: any) {\r\n        return NextResponse.json({ success: false, error: error.message }, { status: 500 })\r\n    }\r\n}\r\n\r\n// DELETE: anulaR compra\r\nexport async function DELETE(request: NextRequest, { params }: { params: Promise<{ id: string }> }) {\r\n    try {\r\n        const { id } = await params\r\n        const [comp] = await query<any[]>('SELECT estado FROM compras WHERE id=?', [id])\r\n        if (!comp) return NextResponse.json({ success: false, error: 'No encontrada' }, { status: 404 })\r\n        if (comp.estado === 'confirmada') return NextResponse.json({ success: false, error: 'No se puede anular una compra confirmada' }, { status: 400 })\r\n        await query(\"UPDATE compras SET estado='anulada' WHERE id=?\", [id])\r\n        return NextResponse.json({ success: true })\r\n    } catch (error: any) {\r\n        return NextResponse.json({ success: false, error: error.message }, { status: 500 })\r\n    }\r\n}\r\n"],"names":[],"mappings":"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"}}]
}