{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 118, "column": 0}, "map": {"version":3,"sources":["file:///D:/Documents/proyectos/valva_boutique_pos/lib/db.ts"],"sourcesContent":["import mysql from 'mysql2/promise';\r\n\r\n// Configuración de la conexión a MySQL\r\nconst dbConfig = {\r\n  host: process.env.DB_HOST || 'localhost',\r\n  port: parseInt(process.env.DB_PORT || '3306'),\r\n  user: process.env.DB_USER || 'root',\r\n  password: process.env.DB_PASSWORD || 'Luciana1510@',\r\n  database: process.env.DB_NAME || 'valva_boutique',\r\n  waitForConnections: true,\r\n  connectionLimit: 10,\r\n  queueLimit: 0,\r\n  enableKeepAlive: true,\r\n  keepAliveInitialDelay: 0,\r\n};\r\n\r\n// Crear el pool de conexiones\r\nlet pool: mysql.Pool;\r\n\r\nexport function getPool(): mysql.Pool {\r\n  if (!pool) {\r\n    pool = mysql.createPool(dbConfig);\r\n  }\r\n  return pool;\r\n}\r\n\r\n// Función helper para ejecutar queries\r\nexport async function query<T = any>(\r\n  sql: string,\r\n  params?: any[]\r\n): Promise<T> {\r\n  const connection = await getPool().getConnection();\r\n  try {\r\n    const [results] = await connection.execute(sql, params);\r\n    return results as T;\r\n  } finally {\r\n    connection.release();\r\n  }\r\n}\r\n\r\n// Función helper para ejecutar queries con múltiples resultados\r\nexport async function queryMultiple<T = any>(\r\n  sql: string,\r\n  params?: any[]\r\n): Promise<T[]> {\r\n  const connection = await getPool().getConnection();\r\n  try {\r\n    const [results] = await connection.query(sql, params);\r\n    return results as T[];\r\n  } finally {\r\n    connection.release();\r\n  }\r\n}\r\n\r\n// Función para obtener una sola fila\r\nexport async function queryOne<T = any>(\r\n  sql: string,\r\n  params?: any[]\r\n): Promise<T | null> {\r\n  const results = await query<T[]>(sql, params);\r\n  return results.length > 0 ? results[0] : null;\r\n}\r\n\r\n// Función para ejecutar transacciones\r\nexport async function transaction<T>(\r\n  callback: (connection: mysql.PoolConnection) => Promise<T>\r\n): Promise<T> {\r\n  const connection = await getPool().getConnection();\r\n  try {\r\n    await connection.beginTransaction();\r\n    const result = await callback(connection);\r\n    await connection.commit();\r\n    return result;\r\n  } catch (error) {\r\n    await connection.rollback();\r\n    throw error;\r\n  } finally {\r\n    connection.release();\r\n  }\r\n}\r\n\r\n// Exportar tipos útiles\r\nexport type { PoolConnection, RowDataPacket, ResultSetHeader } from 'mysql2/promise';\r\n\r\n// Función para cerrar el pool (útil para testing)\r\nexport async function closePool(): Promise<void> {\r\n  if (pool) {\r\n    await pool.end();\r\n  }\r\n}\r\n\r\n// Función para verificar la conexión\r\nexport async function checkConnection(): Promise<boolean> {\r\n  try {\r\n    const connection = await getPool().getConnection();\r\n    await connection.ping();\r\n    connection.release();\r\n    return true;\r\n  } catch (error) {\r\n    console.error('Error al conectar con la base de datos:', error);\r\n    return false;\r\n  }\r\n}\r\n"],"names":[],"mappings":";;;;;;;;;;;;;;;;AAAA;;AAEA,uCAAuC;AACvC,MAAM,WAAW;IACf,MAAM,QAAQ,GAAG,CAAC,OAAO,IAAI;IAC7B,MAAM,SAAS,QAAQ,GAAG,CAAC,OAAO,IAAI;IACtC,MAAM,QAAQ,GAAG,CAAC,OAAO,IAAI;IAC7B,UAAU,QAAQ,GAAG,CAAC,WAAW,IAAI;IACrC,UAAU,QAAQ,GAAG,CAAC,OAAO,IAAI;IACjC,oBAAoB;IACpB,iBAAiB;IACjB,YAAY;IACZ,iBAAiB;IACjB,uBAAuB;AACzB;AAEA,8BAA8B;AAC9B,IAAI;AAEG,SAAS;IACd,IAAI,CAAC,MAAM;QACT,OAAO,kMAAK,CAAC,UAAU,CAAC;IAC1B;IACA,OAAO;AACT;AAGO,eAAe,MACpB,GAAW,EACX,MAAc;IAEd,MAAM,aAAa,MAAM,UAAU,aAAa;IAChD,IAAI;QACF,MAAM,CAAC,QAAQ,GAAG,MAAM,WAAW,OAAO,CAAC,KAAK;QAChD,OAAO;IACT,SAAU;QACR,WAAW,OAAO;IACpB;AACF;AAGO,eAAe,cACpB,GAAW,EACX,MAAc;IAEd,MAAM,aAAa,MAAM,UAAU,aAAa;IAChD,IAAI;QACF,MAAM,CAAC,QAAQ,GAAG,MAAM,WAAW,KAAK,CAAC,KAAK;QAC9C,OAAO;IACT,SAAU;QACR,WAAW,OAAO;IACpB;AACF;AAGO,eAAe,SACpB,GAAW,EACX,MAAc;IAEd,MAAM,UAAU,MAAM,MAAW,KAAK;IACtC,OAAO,QAAQ,MAAM,GAAG,IAAI,OAAO,CAAC,EAAE,GAAG;AAC3C;AAGO,eAAe,YACpB,QAA0D;IAE1D,MAAM,aAAa,MAAM,UAAU,aAAa;IAChD,IAAI;QACF,MAAM,WAAW,gBAAgB;QACjC,MAAM,SAAS,MAAM,SAAS;QAC9B,MAAM,WAAW,MAAM;QACvB,OAAO;IACT,EAAE,OAAO,OAAO;QACd,MAAM,WAAW,QAAQ;QACzB,MAAM;IACR,SAAU;QACR,WAAW,OAAO;IACpB;AACF;AAMO,eAAe;IACpB,IAAI,MAAM;QACR,MAAM,KAAK,GAAG;IAChB;AACF;AAGO,eAAe;IACpB,IAAI;QACF,MAAM,aAAa,MAAM,UAAU,aAAa;QAChD,MAAM,WAAW,IAAI;QACrB,WAAW,OAAO;QAClB,OAAO;IACT,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,2CAA2C;QACzD,OAAO;IACT;AACF"}},
    {"offset": {"line": 237, "column": 0}, "map": {"version":3,"sources":["file:///D:/Documents/proyectos/valva_boutique_pos/app/api/auth/%5B...nextauth%5D/route.ts"],"sourcesContent":["// @ts-nocheck\r\nimport NextAuth from 'next-auth';\r\nimport type { AuthOptions } from 'next-auth';\r\nimport CredentialsProvider from 'next-auth/providers/credentials';\r\nimport bcrypt from 'bcryptjs';\r\nimport { queryOne } from '@/lib/db';\r\n\r\nexport const authOptions: AuthOptions = {\r\n  providers: [\r\n    CredentialsProvider({\r\n      name: 'Credentials',\r\n      credentials: {\r\n        username: { label: \"Username\", type: \"text\" },\r\n        password: { label: \"Password\", type: \"password\" }\r\n      },\r\n      async authorize(credentials) {\r\n        if (!credentials?.username || !credentials?.password) {\r\n          console.log('[Auth] Credenciales faltantes');\r\n          return null;\r\n        }\r\n\r\n        try {\r\n          console.log('[Auth] Buscando usuario:', credentials.username);\r\n          \r\n          const user = await queryOne<any>(\r\n            'SELECT * FROM usuarios WHERE username = ? AND estado = ?',\r\n            [credentials.username, 'activo']\r\n          );\r\n\r\n          if (!user) {\r\n            console.log('[Auth] Usuario no encontrado o inactivo');\r\n            return null;\r\n          }\r\n\r\n          console.log('[Auth] Usuario encontrado, verificando contraseña...');\r\n          const isValid = await bcrypt.compare(credentials.password, user.password_hash);\r\n\r\n          if (!isValid) {\r\n            console.log('[Auth] Contraseña incorrecta');\r\n            return null;\r\n          }\r\n\r\n          console.log('[Auth] Autenticación exitosa');\r\n\r\n          // Actualizar último acceso\r\n          await queryOne(\r\n            'UPDATE usuarios SET ultimo_acceso = CURRENT_TIMESTAMP WHERE id = ?',\r\n            [user.id]\r\n          );\r\n\r\n          return {\r\n            id: user.id.toString(),\r\n            name: `${user.nombre} ${user.apellido}`,\r\n            email: user.email,\r\n            username: user.username,\r\n            rol: user.rol,\r\n          };\r\n        } catch (error) {\r\n          console.error('Error en autenticación:', error);\r\n          return null;\r\n        }\r\n      }\r\n    })\r\n  ],\r\n  session: {\r\n    strategy: 'jwt',\r\n  },\r\n  callbacks: {\r\n    async jwt({ token, user }) {\r\n      if (user) {\r\n        token.id = user.id;\r\n        token.username = (user as any).username;\r\n        token.rol = (user as any).rol;\r\n      }\r\n      return token;\r\n    },\r\n    async session({ session, token }) {\r\n      if (session.user) {\r\n        (session.user as any).id = token.id;\r\n        (session.user as any).username = token.username;\r\n        (session.user as any).rol = token.rol;\r\n      }\r\n      return session;\r\n    }\r\n  },\r\n  pages: {\r\n    signIn: '/login',\r\n  },\r\n  secret: process.env.NEXTAUTH_SECRET,\r\n};\r\n\r\nconst handler = NextAuth(authOptions);\r\nexport { handler as GET, handler as POST };\r\n"],"names":[],"mappings":"AAAA,cAAc;;;;;;;;;AACd;AAEA;AACA;AACA;;;;;AAEO,MAAM,cAA2B;IACtC,WAAW;QACT,IAAA,iRAAmB,EAAC;YAClB,MAAM;YACN,aAAa;gBACX,UAAU;oBAAE,OAAO;oBAAY,MAAM;gBAAO;gBAC5C,UAAU;oBAAE,OAAO;oBAAY,MAAM;gBAAW;YAClD;YACA,MAAM,WAAU,WAAW;gBACzB,IAAI,CAAC,aAAa,YAAY,CAAC,aAAa,UAAU;oBACpD,QAAQ,GAAG,CAAC;oBACZ,OAAO;gBACT;gBAEA,IAAI;oBACF,QAAQ,GAAG,CAAC,4BAA4B,YAAY,QAAQ;oBAE5D,MAAM,OAAO,MAAM,IAAA,uHAAQ,EACzB,4DACA;wBAAC,YAAY,QAAQ;wBAAE;qBAAS;oBAGlC,IAAI,CAAC,MAAM;wBACT,QAAQ,GAAG,CAAC;wBACZ,OAAO;oBACT;oBAEA,QAAQ,GAAG,CAAC;oBACZ,MAAM,UAAU,MAAM,mMAAM,CAAC,OAAO,CAAC,YAAY,QAAQ,EAAE,KAAK,aAAa;oBAE7E,IAAI,CAAC,SAAS;wBACZ,QAAQ,GAAG,CAAC;wBACZ,OAAO;oBACT;oBAEA,QAAQ,GAAG,CAAC;oBAEZ,2BAA2B;oBAC3B,MAAM,IAAA,uHAAQ,EACZ,sEACA;wBAAC,KAAK,EAAE;qBAAC;oBAGX,OAAO;wBACL,IAAI,KAAK,EAAE,CAAC,QAAQ;wBACpB,MAAM,GAAG,KAAK,MAAM,CAAC,CAAC,EAAE,KAAK,QAAQ,EAAE;wBACvC,OAAO,KAAK,KAAK;wBACjB,UAAU,KAAK,QAAQ;wBACvB,KAAK,KAAK,GAAG;oBACf;gBACF,EAAE,OAAO,OAAO;oBACd,QAAQ,KAAK,CAAC,2BAA2B;oBACzC,OAAO;gBACT;YACF;QACF;KACD;IACD,SAAS;QACP,UAAU;IACZ;IACA,WAAW;QACT,MAAM,KAAI,EAAE,KAAK,EAAE,IAAI,EAAE;YACvB,IAAI,MAAM;gBACR,MAAM,EAAE,GAAG,KAAK,EAAE;gBAClB,MAAM,QAAQ,GAAG,AAAC,KAAa,QAAQ;gBACvC,MAAM,GAAG,GAAG,AAAC,KAAa,GAAG;YAC/B;YACA,OAAO;QACT;QACA,MAAM,SAAQ,EAAE,OAAO,EAAE,KAAK,EAAE;YAC9B,IAAI,QAAQ,IAAI,EAAE;gBACf,QAAQ,IAAI,CAAS,EAAE,GAAG,MAAM,EAAE;gBAClC,QAAQ,IAAI,CAAS,QAAQ,GAAG,MAAM,QAAQ;gBAC9C,QAAQ,IAAI,CAAS,GAAG,GAAG,MAAM,GAAG;YACvC;YACA,OAAO;QACT;IACF;IACA,OAAO;QACL,QAAQ;IACV;IACA,QAAQ,QAAQ,GAAG,CAAC,eAAe;AACrC;AAEA,MAAM,UAAU,IAAA,8PAAQ,EAAC"}},
    {"offset": {"line": 340, "column": 0}, "map": {"version":3,"sources":["file:///D:/Documents/proyectos/valva_boutique_pos/lib/auth/permissions.ts"],"sourcesContent":["export type Role = 'administrador' | 'vendedor';\r\n\r\nexport type Permission =\r\n  // Productos\r\n  | 'productos.ver'\r\n  | 'productos.crear'\r\n  | 'productos.editar'\r\n  | 'productos.eliminar'\r\n  | 'productos.precios'\r\n  // Inventario\r\n  | 'inventario.ver'\r\n  | 'inventario.ajustar'\r\n  | 'inventario.movimientos'\r\n  // Ventas\r\n  | 'ventas.crear'\r\n  | 'ventas.ver'\r\n  | 'ventas.anular'\r\n  | 'ventas.devolucion'\r\n  // Clientes\r\n  | 'clientes.ver'\r\n  | 'clientes.crear'\r\n  | 'clientes.editar'\r\n  | 'clientes.eliminar'\r\n  | 'clientes.abonar'\r\n  // Proveedores\r\n  | 'proveedores.ver'\r\n  | 'proveedores.crear'\r\n  | 'proveedores.editar'\r\n  | 'proveedores.eliminar'\r\n  // Compras\r\n  | 'compras.ver'\r\n  | 'compras.crear'\r\n  | 'compras.editar'\r\n  | 'compras.anular'\r\n  // Caja\r\n  | 'caja.abrir'\r\n  | 'caja.cerrar'\r\n  | 'caja.movimientos'\r\n  | 'caja.ver'\r\n  // Reportes\r\n  | 'reportes.ventas'\r\n  | 'reportes.inventario'\r\n  | 'reportes.financieros'\r\n  | 'reportes.clientes'\r\n  // Configuración\r\n  | 'config.ver'\r\n  | 'config.editar'\r\n  | 'config.webhooks'\r\n  // Usuarios\r\n  | 'usuarios.ver'\r\n  | 'usuarios.crear'\r\n  | 'usuarios.editar'\r\n  | 'usuarios.eliminar'\r\n  // Descuentos\r\n  | 'descuentos.ver'\r\n  | 'descuentos.crear'\r\n  | 'descuentos.editar'\r\n  | 'descuentos.eliminar'\r\n  // Gastos\r\n  | 'gastos.ver'\r\n  | 'gastos.crear'\r\n  | 'gastos.editar'\r\n  | 'gastos.eliminar';\r\n\r\n// Definir permisos por rol (FUENTE ÚNICA DE VERDAD)\r\nexport const ROLE_PERMISSIONS: Record<Role, Permission[]> = {\r\n  administrador: [\r\n    // TODOS los permisos\r\n    'productos.ver',\r\n    'productos.crear',\r\n    'productos.editar',\r\n    'productos.eliminar',\r\n    'productos.precios',\r\n    'inventario.ver',\r\n    'inventario.ajustar',\r\n    'inventario.movimientos',\r\n    'ventas.crear',\r\n    'ventas.ver',\r\n    'ventas.anular',\r\n    'ventas.devolucion',\r\n    'clientes.ver',\r\n    'clientes.crear',\r\n    'clientes.editar',\r\n    'clientes.eliminar',\r\n    'clientes.abonar',\r\n    'proveedores.ver',\r\n    'proveedores.crear',\r\n    'proveedores.editar',\r\n    'proveedores.eliminar',\r\n    'compras.ver',\r\n    'compras.crear',\r\n    'compras.editar',\r\n    'compras.anular',\r\n    'caja.abrir',\r\n    'caja.cerrar',\r\n    'caja.movimientos',\r\n    'caja.ver',\r\n    'reportes.ventas',\r\n    'reportes.inventario',\r\n    'reportes.financieros',\r\n    'reportes.clientes',\r\n    'config.ver',\r\n    'config.editar',\r\n    'config.webhooks',\r\n    'usuarios.ver',\r\n    'usuarios.crear',\r\n    'usuarios.editar',\r\n    'usuarios.eliminar',\r\n    'descuentos.ver',\r\n    'descuentos.crear',\r\n    'descuentos.editar',\r\n    'descuentos.eliminar',\r\n    'gastos.ver',\r\n    'gastos.crear',\r\n    'gastos.editar',\r\n    'gastos.eliminar',\r\n  ],\r\n  \r\n  vendedor: [\r\n    // Solo puede abrir caja y registrar ventas\r\n    'caja.abrir',\r\n    'caja.cerrar',\r\n    'ventas.crear',\r\n    'ventas.ver',\r\n    'clientes.ver', // Necesita ver clientes para asignar en ventas\r\n    'clientes.abonar', // Puede registrar abonos\r\n  ],\r\n};\r\n\r\n// Función para verificar si un rol tiene un permiso\r\nexport function hasPermission(role: Role, permission: Permission): boolean {\r\n  return ROLE_PERMISSIONS[role].includes(permission);\r\n}\r\n\r\n// Función para obtener todos los permisos de un rol\r\nexport function getRolePermissions(role: Role): Permission[] {\r\n  return ROLE_PERMISSIONS[role];\r\n}\r\n\r\n// Información descriptiva de roles\r\nexport const ROLE_INFO: Record<Role, { nombre: string; descripcion: string; color: string }> = {\r\n  administrador: {\r\n    nombre: 'Administrador',\r\n    descripcion: 'Acceso total al sistema con todos los permisos',\r\n    color: 'bg-red-500',\r\n  },\r\n  vendedor: {\r\n    nombre: 'Vendedor',\r\n    descripcion: 'Puede abrir caja y registrar ventas únicamente',\r\n    color: 'bg-blue-500',\r\n  },\r\n};\r\n\r\n// Obtener información de un permiso\r\nexport const PERMISSION_INFO: Record<Permission, { nombre: string; modulo: string }> = {\r\n  'productos.ver': { nombre: 'Ver Productos', modulo: 'Productos' },\r\n  'productos.crear': { nombre: 'Crear Productos', modulo: 'Productos' },\r\n  'productos.editar': { nombre: 'Editar Productos', modulo: 'Productos' },\r\n  'productos.eliminar': { nombre: 'Eliminar Productos', modulo: 'Productos' },\r\n  'productos.precios': { nombre: 'Gestionar Precios', modulo: 'Productos' },\r\n  'inventario.ver': { nombre: 'Ver Inventario', modulo: 'Inventario' },\r\n  'inventario.ajustar': { nombre: 'Ajustar Inventario', modulo: 'Inventario' },\r\n  'inventario.movimientos': { nombre: 'Ver Movimientos', modulo: 'Inventario' },\r\n  'ventas.crear': { nombre: 'Realizar Ventas', modulo: 'Ventas' },\r\n  'ventas.ver': { nombre: 'Ver Ventas', modulo: 'Ventas' },\r\n  'ventas.anular': { nombre: 'Anular Ventas', modulo: 'Ventas' },\r\n  'ventas.devolucion': { nombre: 'Procesar Devoluciones', modulo: 'Ventas' },\r\n  'clientes.ver': { nombre: 'Ver Clientes', modulo: 'Clientes' },\r\n  'clientes.crear': { nombre: 'Crear Clientes', modulo: 'Clientes' },\r\n  'clientes.editar': { nombre: 'Editar Clientes', modulo: 'Clientes' },\r\n  'clientes.eliminar': { nombre: 'Eliminar Clientes', modulo: 'Clientes' },\r\n  'proveedores.ver': { nombre: 'Ver Proveedores', modulo: 'Proveedores' },\r\n  'proveedores.crear': { nombre: 'Crear Proveedores', modulo: 'Proveedores' },\r\n  'proveedores.editar': { nombre: 'Editar Proveedores', modulo: 'Proveedores' },\r\n  'proveedores.eliminar': { nombre: 'Eliminar Proveedores', modulo: 'Proveedores' },\r\n  'compras.ver': { nombre: 'Ver Compras', modulo: 'Compras' },\r\n  'compras.crear': { nombre: 'Crear Compras', modulo: 'Compras' },\r\n  'compras.editar': { nombre: 'Editar Compras', modulo: 'Compras' },\r\n  'compras.anular': { nombre: 'Anular Compras', modulo: 'Compras' },\r\n  'caja.abrir': { nombre: 'Abrir Caja', modulo: 'Caja' },\r\n  'caja.cerrar': { nombre: 'Cerrar Caja', modulo: 'Caja' },\r\n  'caja.movimientos': { nombre: 'Gestionar Movimientos', modulo: 'Caja' },\r\n  'caja.ver': { nombre: 'Ver Caja', modulo: 'Caja' },\r\n  'reportes.ventas': { nombre: 'Reportes de Ventas', modulo: 'Reportes' },\r\n  'reportes.inventario': { nombre: 'Reportes de Inventario', modulo: 'Reportes' },\r\n  'reportes.financieros': { nombre: 'Reportes Financieros', modulo: 'Reportes' },\r\n  'reportes.clientes': { nombre: 'Reportes de Clientes', modulo: 'Reportes' },\r\n  'config.ver': { nombre: 'Ver Configuración', modulo: 'Configuración' },\r\n  'config.editar': { nombre: 'Editar Configuración', modulo: 'Configuración' },\r\n  'config.webhooks': { nombre: 'Gestionar Webhooks', modulo: 'Configuración' },\r\n  'usuarios.ver': { nombre: 'Ver Usuarios', modulo: 'Usuarios' },\r\n  'usuarios.crear': { nombre: 'Crear Usuarios', modulo: 'Usuarios' },\r\n  'usuarios.editar': { nombre: 'Editar Usuarios', modulo: 'Usuarios' },\r\n  'usuarios.eliminar': { nombre: 'Eliminar Usuarios', modulo: 'Usuarios' },\r\n  'descuentos.ver': { nombre: 'Ver Descuentos', modulo: 'Descuentos' },\r\n  'descuentos.crear': { nombre: 'Crear Descuentos', modulo: 'Descuentos' },\r\n  'descuentos.editar': { nombre: 'Editar Descuentos', modulo: 'Descuentos' },\r\n  'descuentos.eliminar': { nombre: 'Eliminar Descuentos', modulo: 'Descuentos' },\r\n  'gastos.ver': { nombre: 'Ver Gastos', modulo: 'Gastos' },\r\n  'gastos.crear': { nombre: 'Crear Gastos', modulo: 'Gastos' },\r\n  'gastos.editar': { nombre: 'Editar Gastos', modulo: 'Gastos' },\r\n  'gastos.eliminar': { nombre: 'Eliminar Gastos', modulo: 'Gastos' },\r\n  'clientes.abonar': { nombre: 'Registrar Abonos', modulo: 'Clientes' },\r\n};\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 630, "column": 0}, "map": {"version":3,"sources":["file:///D:/Documents/proyectos/valva_boutique_pos/lib/auth/check-permission.ts"],"sourcesContent":["// @ts-nocheck\r\nimport { getServerSession } from 'next-auth/next';\r\nimport { hasPermission, type Permission, type Role } from './permissions';\r\nimport { authOptions } from '@/app/api/auth/[...nextauth]/route';\r\n\r\n// Verificar si el usuario actual tiene un permiso específico\r\nexport async function checkPermission(permission: Permission): Promise<boolean> {\r\n  try {\r\n    const session = await getServerSession(authOptions);\r\n    \r\n    if (!session?.user?.rol) {\r\n      return false;\r\n    }\r\n    \r\n    return hasPermission(session.user.rol as Role, permission);\r\n  } catch (error) {\r\n    console.error('Error checking permission:', error);\r\n    return false;\r\n  }\r\n}\r\n\r\n// Middleware para requerir un permiso (lanza error si no lo tiene)\r\nexport async function requirePermission(permission: Permission): Promise<void> {\r\n  try {\r\n    const session = await getServerSession(authOptions);\r\n    \r\n    if (!session?.user?.rol) {\r\n      throw new Error('Debes iniciar sesión para acceder a este recurso');\r\n    }\r\n    \r\n    const allowed = hasPermission(session.user.rol as Role, permission);\r\n    \r\n    if (!allowed) {\r\n      throw new Error('No tienes permiso para realizar esta acción');\r\n    }\r\n  } catch (error) {\r\n    throw error;\r\n  }\r\n}\r\n\r\n// Verificar si el usuario tiene alguno de los permisos especificados\r\nexport async function checkAnyPermission(permissions: Permission[]): Promise<boolean> {\r\n  const session = await getServerSession(authOptions);\r\n  \r\n  if (!session?.user?.rol) {\r\n    return false;\r\n  }\r\n  \r\n  return permissions.some(permission => \r\n    hasPermission(session.user.rol as Role, permission)\r\n  );\r\n}\r\n\r\n// Verificar si el usuario tiene todos los permisos especificados\r\nexport async function checkAllPermissions(permissions: Permission[]): Promise<boolean> {\r\n  const session = await getServerSession(authOptions);\r\n  \r\n  if (!session?.user?.rol) {\r\n    return false;\r\n  }\r\n  \r\n  return permissions.every(permission => \r\n    hasPermission(session.user.rol as Role, permission)\r\n  );\r\n}\r\n\r\n// Obtener el rol del usuario actual\r\nexport async function getCurrentUserRole(): Promise<Role | null> {\r\n  const session = await getServerSession(authOptions);\r\n  return (session?.user?.rol as Role) || null;\r\n}\r\n\r\n// Verificar si el usuario es administrador\r\nexport async function isAdmin(): Promise<boolean> {\r\n  const role = await getCurrentUserRole();\r\n  return role === 'administrador';\r\n}\r\n\r\n// Verificar si el usuario es vendedor\r\nexport async function isVendedor(): Promise<boolean> {\r\n  const role = await getCurrentUserRole();\r\n  return role === 'vendedor';\r\n}\r\n"],"names":[],"mappings":"AAAA,cAAc;;;;;;;;;;;;;;;;;AACd;AACA;AACA;;;;AAGO,eAAe,gBAAgB,UAAsB;IAC1D,IAAI;QACF,MAAM,UAAU,MAAM,IAAA,+QAAgB,EAAC,kKAAW;QAElD,IAAI,CAAC,SAAS,MAAM,KAAK;YACvB,OAAO;QACT;QAEA,OAAO,IAAA,6IAAa,EAAC,QAAQ,IAAI,CAAC,GAAG,EAAU;IACjD,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,8BAA8B;QAC5C,OAAO;IACT;AACF;AAGO,eAAe,kBAAkB,UAAsB;IAC5D,IAAI;QACF,MAAM,UAAU,MAAM,IAAA,+QAAgB,EAAC,kKAAW;QAElD,IAAI,CAAC,SAAS,MAAM,KAAK;YACvB,MAAM,IAAI,MAAM;QAClB;QAEA,MAAM,UAAU,IAAA,6IAAa,EAAC,QAAQ,IAAI,CAAC,GAAG,EAAU;QAExD,IAAI,CAAC,SAAS;YACZ,MAAM,IAAI,MAAM;QAClB;IACF,EAAE,OAAO,OAAO;QACd,MAAM;IACR;AACF;AAGO,eAAe,mBAAmB,WAAyB;IAChE,MAAM,UAAU,MAAM,IAAA,+QAAgB,EAAC,kKAAW;IAElD,IAAI,CAAC,SAAS,MAAM,KAAK;QACvB,OAAO;IACT;IAEA,OAAO,YAAY,IAAI,CAAC,CAAA,aACtB,IAAA,6IAAa,EAAC,QAAQ,IAAI,CAAC,GAAG,EAAU;AAE5C;AAGO,eAAe,oBAAoB,WAAyB;IACjE,MAAM,UAAU,MAAM,IAAA,+QAAgB,EAAC,kKAAW;IAElD,IAAI,CAAC,SAAS,MAAM,KAAK;QACvB,OAAO;IACT;IAEA,OAAO,YAAY,KAAK,CAAC,CAAA,aACvB,IAAA,6IAAa,EAAC,QAAQ,IAAI,CAAC,GAAG,EAAU;AAE5C;AAGO,eAAe;IACpB,MAAM,UAAU,MAAM,IAAA,+QAAgB,EAAC,kKAAW;IAClD,OAAO,AAAC,SAAS,MAAM,OAAgB;AACzC;AAGO,eAAe;IACpB,MAAM,OAAO,MAAM;IACnB,OAAO,SAAS;AAClB;AAGO,eAAe;IACpB,MAAM,OAAO,MAAM;IACnB,OAAO,SAAS;AAClB"}},
    {"offset": {"line": 709, "column": 0}, "map": {"version":3,"sources":["file:///D:/Documents/proyectos/valva_boutique_pos/app/api/ventas/route.ts"],"sourcesContent":["// @ts-nocheck\r\nimport { NextRequest, NextResponse } from 'next/server';\r\nimport { query, queryOne } from '@/lib/db';\r\nimport { getServerSession } from 'next-auth/next';\r\nimport { authOptions } from '@/app/api/auth/[...nextauth]/route';\r\nimport { requirePermission } from '@/lib/auth/check-permission';\r\n\r\n// GET - Obtener todas las ventas\r\nexport async function GET() {\r\n  try {\r\n    await requirePermission('ventas.ver');\r\n\r\n    const ventas = await query<any[]>(\r\n      `SELECT v.*, \r\n              c.nombre as cliente_nombre,\r\n              u.nombre as vendedor_nombre,\r\n              u.apellido as vendedor_apellido\r\n       FROM ventas v\r\n       LEFT JOIN clientes c ON v.cliente_id = c.id\r\n       LEFT JOIN usuarios u ON v.usuario_id = u.id\r\n       ORDER BY v.fecha_venta DESC\r\n       LIMIT 100`\r\n    );\r\n\r\n    return NextResponse.json({ success: true, data: ventas });\r\n  } catch (error: any) {\r\n    console.error('Error al obtener ventas:', error);\r\n    \r\n    if (error.message?.includes('iniciar sesión')) {\r\n      return NextResponse.json({ error: error.message }, { status: 401 });\r\n    }\r\n    \r\n    return NextResponse.json(\r\n      { error: error.message || 'Error al obtener ventas' },\r\n      { status: error.message?.includes('permiso') ? 403 : 500 }\r\n    );\r\n  }\r\n}\r\n\r\n// POST - Crear nueva venta\r\nexport async function POST(request: NextRequest) {\r\n  try {\r\n    await requirePermission('ventas.crear');\r\n    \r\n    const session = await getServerSession(authOptions);\r\n    if (!session?.user) {\r\n      return NextResponse.json(\r\n        { error: 'Usuario no autenticado' },\r\n        { status: 401 }\r\n      );\r\n    }\r\n\r\n    const body = await request.json();\r\n    const {\r\n      cliente_id,\r\n      tipo_venta,\r\n      metodo_pago,\r\n      productos,\r\n      subtotal,\r\n      iva,\r\n      descuento,\r\n      total,\r\n      descuento_id,\r\n      efectivo_recibido,\r\n      cambio,\r\n      pago_mixto,\r\n      abono,\r\n      referencia_transferencia\r\n    } = body;\r\n\r\n    // Validaciones\r\n    if (!productos || productos.length === 0) {\r\n      return NextResponse.json(\r\n        { error: 'Debe incluir al menos un producto' },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    if (!total || total <= 0) {\r\n      return NextResponse.json(\r\n        { error: 'El total debe ser mayor a 0' },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    // Verificar que la caja esté abierta\r\n    const sesionCaja = await queryOne<any>(\r\n      `SELECT id FROM sesiones_caja WHERE estado = 'abierta' LIMIT 1`\r\n    );\r\n    if (!sesionCaja) {\r\n      return NextResponse.json(\r\n        { error: 'La caja está cerrada. Debe abrir la caja antes de registrar ventas.' },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    // Obtener usuario_id del session\r\n    const usuario_id = (session.user as any).id;\r\n\r\n    // Generar número de venta\r\n    const fecha = new Date();\r\n    const año = fecha.getFullYear();\r\n    const mes = String(fecha.getMonth() + 1).padStart(2, '0');\r\n    const dia = String(fecha.getDate()).padStart(2, '0');\r\n    \r\n    // Obtener el último número de venta del día\r\n    const ultimaVenta = await queryOne<any>(\r\n      `SELECT numero_venta FROM ventas \r\n       WHERE DATE(fecha_venta) = CURDATE() \r\n       ORDER BY id DESC LIMIT 1`\r\n    );\r\n    \r\n    let numeroSecuencial = 1;\r\n    if (ultimaVenta && ultimaVenta.numero_venta) {\r\n      const match = ultimaVenta.numero_venta.match(/-(\\d+)$/);\r\n      if (match) {\r\n        numeroSecuencial = parseInt(match[1]) + 1;\r\n      }\r\n    }\r\n    \r\n    const numero_venta = `VEN-${año}${mes}${dia}-${String(numeroSecuencial).padStart(4, '0')}`;\r\n\r\n    // Obtener caja_id (por ahora usar la primera caja activa)\r\n    const caja = await queryOne<any>(\r\n      `SELECT id FROM cajas WHERE estado = 'activa' LIMIT 1`\r\n    );\r\n    \r\n    const caja_id = caja?.id || null;\r\n\r\n    // Verificar stock disponible\r\n    for (const item of productos) {\r\n      const producto = await queryOne<any>(\r\n        'SELECT id, nombre, stock_actual FROM productos WHERE id = ?',\r\n        [item.producto_id]\r\n      );\r\n\r\n      if (!producto) {\r\n        return NextResponse.json(\r\n          { error: `Producto con ID ${item.producto_id} no encontrado` },\r\n          { status: 400 }\r\n        );\r\n      }\r\n\r\n      if (producto.stock_actual < item.cantidad) {\r\n        return NextResponse.json(\r\n          { \r\n            error: `Stock insuficiente para ${producto.nombre}. Disponible: ${producto.stock_actual}, Requerido: ${item.cantidad}` \r\n          },\r\n          { status: 400 }\r\n        );\r\n      }\r\n    }\r\n\r\n    // Insertar venta\r\n    const resultVenta = await query<any>(\r\n      `INSERT INTO ventas (\r\n        numero_venta, cliente_id, fecha_venta, subtotal, iva, descuento, total,\r\n        estado, descuento_id, usuario_id, caja_id, tipo_venta, metodo_pago,\r\n        efectivo_recibido, cambio, referencia_transferencia\r\n      ) VALUES (?, ?, NOW(), ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)`,\r\n      [\r\n        numero_venta,\r\n        cliente_id || null,\r\n        subtotal || 0,\r\n        iva || 0,\r\n        descuento || 0,\r\n        total,\r\n        tipo_venta === 'credito' ? 'credito' : 'completada',\r\n        descuento_id || null,\r\n        usuario_id,\r\n        caja_id,\r\n        tipo_venta || 'contado',\r\n        metodo_pago || 'efectivo',\r\n        efectivo_recibido || null,\r\n        cambio || null,\r\n        referencia_transferencia || null\r\n      ]\r\n    );\r\n\r\n    const venta_id = (resultVenta as any).insertId;\r\n\r\n    // Si es pago mixto, registrar desglose\r\n    if (metodo_pago === 'mixto' && pago_mixto) {\r\n      await query(\r\n        `INSERT INTO pagos_mixtos_ventas (\r\n          venta_id, monto_efectivo, monto_transferencia, referencia_transferencia\r\n        ) VALUES (?, ?, ?, ?)`,\r\n        [\r\n          venta_id,\r\n          pago_mixto.efectivo || 0,\r\n          pago_mixto.transferencia || 0,\r\n          referencia_transferencia || null\r\n        ]\r\n      );\r\n    }\r\n\r\n    // Insertar detalles de venta y actualizar stock\r\n    for (const item of productos) {\r\n      // Obtener stock actual antes de actualizar\r\n      const productoActual = await queryOne<any>(\r\n        'SELECT stock_actual FROM productos WHERE id = ?',\r\n        [item.producto_id]\r\n      );\r\n      const stock_anterior = productoActual?.stock_actual || 0;\r\n      const stock_nuevo = stock_anterior - item.cantidad;\r\n\r\n      // Insertar detalle\r\n      await query(\r\n        `INSERT INTO detalle_ventas (venta_id, producto_id, cantidad, precio_unitario, subtotal)\r\n         VALUES (?, ?, ?, ?, ?)`,\r\n        [\r\n          venta_id,\r\n          item.producto_id,\r\n          item.cantidad,\r\n          item.precio_unitario,\r\n          item.cantidad * item.precio_unitario\r\n        ]\r\n      );\r\n\r\n      // Actualizar stock\r\n      await query(\r\n        `UPDATE productos \r\n         SET stock_actual = stock_actual - ? \r\n         WHERE id = ?`,\r\n        [item.cantidad, item.producto_id]\r\n      );\r\n\r\n      // Registrar movimiento de inventario\r\n      await query(\r\n        `INSERT INTO movimientos_inventario (\r\n          producto_id, tipo_movimiento, cantidad, stock_anterior, \r\n          stock_nuevo, motivo, venta_id, usuario_id, fecha_movimiento\r\n        ) VALUES (?, 'salida_venta', ?, ?, ?, 'Venta', ?, ?, NOW())`,\r\n        [item.producto_id, -item.cantidad, stock_anterior, stock_nuevo, venta_id, usuario_id]\r\n      );\r\n    }\r\n\r\n    // Si es venta a crédito, crear registro de cuenta por cobrar\r\n    if (tipo_venta === 'credito' && cliente_id) {\r\n      // IMPORTANTE: saldo_pendiente inicial debe ser el total completo\r\n      // El trigger actualizar_saldo_cliente_abono se encargará de restar el abono cuando se inserte\r\n      const resultCuenta = await query(\r\n        `INSERT INTO cuentas_por_cobrar (\r\n          cliente_id, venta_id, monto_total, saldo_pendiente, \r\n          fecha_vencimiento, estado\r\n        ) VALUES (?, ?, ?, ?, DATE_ADD(NOW(), INTERVAL 30 DAY), 'pendiente')`,\r\n        [\r\n          cliente_id, \r\n          venta_id, \r\n          total, \r\n          total  // Siempre usar el total completo, el trigger restará el abono después\r\n        ]\r\n      );\r\n\r\n      const cuenta_por_cobrar_id = (resultCuenta as any).insertId;\r\n\r\n      // Si hay abono inicial, registrarlo\r\n      if (abono && abono.monto > 0) {\r\n        const resultAbono = await query(\r\n          `INSERT INTO abonos (\r\n            cuenta_por_cobrar_id, monto, metodo_pago, usuario_id, notas, referencia_transferencia\r\n          ) VALUES (?, ?, ?, ?, 'Abono inicial', ?)`,\r\n          [\r\n            cuenta_por_cobrar_id,\r\n            abono.monto,\r\n            abono.metodo,\r\n            usuario_id,\r\n            abono.referenciaTransferencia || null\r\n          ]\r\n        );\r\n\r\n        const abono_id = (resultAbono as any).insertId;\r\n\r\n        // Si el abono es mixto, registrar desglose\r\n        if (abono.metodo === 'mixto') {\r\n          await query(\r\n            `INSERT INTO pagos_mixtos_abonos (\r\n              abono_id, monto_efectivo, monto_transferencia, referencia_transferencia\r\n            ) VALUES (?, ?, ?, ?)`,\r\n            [\r\n              abono_id,\r\n              abono.montoEfectivo || 0,\r\n              abono.montoTransferencia || 0,\r\n              abono.referenciaTransferencia || null\r\n            ]\r\n          );\r\n        }\r\n      }\r\n\r\n      // Actualizar saldo del cliente\r\n      // IMPORTANTE: Se suma el total completo\r\n      // El trigger actualizar_saldo_cliente_abono se encargará de restar el abono del saldo\r\n      await query(\r\n        `UPDATE clientes \r\n         SET saldo_pendiente = saldo_pendiente + ?,\r\n             saldo_actual = saldo_actual + ?\r\n         WHERE id = ?`,\r\n        [total, total, cliente_id]\r\n      );\r\n    }\r\n\r\n    // Si hay sesión de caja abierta, registrar movimiento\r\n    if (caja_id && tipo_venta === 'contado') {\r\n      const sesionCaja = await queryOne<any>(\r\n        `SELECT id FROM sesiones_caja \r\n         WHERE caja_id = ? AND estado = 'abierta' AND usuario_id = ?\r\n         ORDER BY fecha_apertura DESC LIMIT 1`,\r\n        [caja_id, usuario_id]\r\n      );\r\n\r\n      if (sesionCaja) {\r\n        await query(\r\n          `INSERT INTO movimientos_caja (\r\n            sesion_caja_id, tipo_movimiento, monto, venta_id, \r\n            usuario_id, fecha_movimiento\r\n          ) VALUES (?, 'venta', ?, ?, ?, NOW())`,\r\n          [sesionCaja.id, total, venta_id, usuario_id]\r\n        );\r\n      }\r\n    }\r\n\r\n    // Obtener la venta completa con detalles\r\n    const ventaCompleta = await queryOne<any>(\r\n      `SELECT v.*, \r\n              c.nombre as cliente_nombre,\r\n              c.identificacion as cliente_identificacion,\r\n              c.telefono as cliente_telefono,\r\n              c.direccion as cliente_direccion,\r\n              u.nombre as vendedor_nombre,\r\n              u.apellido as vendedor_apellido,\r\n              cpc.monto_total as credito_monto_total,\r\n              cpc.saldo_pendiente as credito_saldo_pendiente,\r\n              (SELECT COALESCE(SUM(a.monto), 0) \r\n               FROM abonos a \r\n               WHERE a.cuenta_por_cobrar_id = cpc.id) as credito_abono_total\r\n       FROM ventas v\r\n       LEFT JOIN clientes c ON v.cliente_id = c.id\r\n       LEFT JOIN usuarios u ON v.usuario_id = u.id\r\n       LEFT JOIN cuentas_por_cobrar cpc ON v.id = cpc.venta_id\r\n       WHERE v.id = ?`,\r\n      [venta_id]\r\n    );\r\n\r\n    // Obtener detalles de la venta\r\n    const detalles = await query<any[]>(\r\n      `SELECT dv.*, \r\n              p.nombre as producto_nombre,\r\n              p.sku,\r\n              p.codigo_barras\r\n       FROM detalle_ventas dv\r\n       INNER JOIN productos p ON dv.producto_id = p.id\r\n       WHERE dv.venta_id = ?`,\r\n      [venta_id]\r\n    );\r\n\r\n    ventaCompleta.detalles = detalles;\r\n\r\n    return NextResponse.json({\r\n      success: true,\r\n      data: ventaCompleta,\r\n      message: 'Venta registrada exitosamente'\r\n    }, { status: 201 });\r\n\r\n  } catch (error: any) {\r\n    console.error('Error al crear venta:', error);\r\n    return NextResponse.json(\r\n      { error: error.message || 'Error al crear venta' },\r\n      { status: error.message?.includes('permiso') ? 403 : 500 }\r\n    );\r\n  }\r\n}\r\n"],"names":[],"mappings":"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"}}]
}