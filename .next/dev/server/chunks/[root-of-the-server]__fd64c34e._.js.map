{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Oscar%20Llain/OneDrive/Documentos/VALVA/valva_boutique_pos/lib/barcode-generator.ts"],"sourcesContent":["/**\r\n * Generador de SKU y Códigos de Barras para Sistema de Ropa\r\n * \r\n * SKU Format: CAT-TIPO-TALLA-SECUENCIA\r\n * Ejemplo: PAN-JEA-28-0001\r\n * \r\n * Código de Barras: EAN-13 interno (prefijo 200-299 para uso interno)\r\n */\r\n\r\n/**\r\n * Genera un SKU basado en la información del producto\r\n */\r\nexport function generateSKU(\r\n  categoriaNombre: string,\r\n  tipoPrendaNombre: string,\r\n  tallaNombre: string,\r\n  secuencia: number\r\n): string {\r\n  const skuPrefix = generateSKUPrefix(categoriaNombre, tipoPrendaNombre, tallaNombre)\r\n  \r\n  // Secuencia con 4 dígitos\r\n  const secCode = secuencia.toString().padStart(4, '0')\r\n  \r\n  return `${skuPrefix}-${secCode}`\r\n}\r\n\r\n/**\r\n * Genera el prefijo del SKU (sin la secuencia)\r\n */\r\nexport function generateSKUPrefix(\r\n  categoriaNombre: string,\r\n  tipoPrendaNombre: string,\r\n  tallaNombre: string\r\n): string {\r\n  // Extraer 3 primeras letras de categoría\r\n  const catCode = categoriaNombre.substring(0, 3).toUpperCase()\r\n  \r\n  // Extraer código del tipo de prenda (primeras 3 letras o abreviatura inteligente)\r\n  let tipoCode = ''\r\n  const tipoWords = tipoPrendaNombre.split(' ')\r\n  if (tipoWords.length > 1) {\r\n    // Si tiene múltiples palabras, tomar primera letra de cada una\r\n    tipoCode = tipoWords.slice(0, 3).map(w => w[0]).join('').toUpperCase()\r\n  } else {\r\n    tipoCode = tipoPrendaNombre.substring(0, 3).toUpperCase()\r\n  }\r\n  \r\n  // Talla (ya viene limpia)\r\n  const tallaCode = tallaNombre.toUpperCase().replace(/\\s/g, '')\r\n  \r\n  return `${catCode}-${tipoCode}-${tallaCode}`\r\n}\r\n\r\n/**\r\n * Calcula el dígito verificador para EAN-13\r\n */\r\nfunction calculateEAN13CheckDigit(code: string): number {\r\n  const digits = code.split('').map(Number)\r\n  let sum = 0\r\n  \r\n  for (let i = 0; i < 12; i++) {\r\n    sum += digits[i] * (i % 2 === 0 ? 1 : 3)\r\n  }\r\n  \r\n  const remainder = sum % 10\r\n  return remainder === 0 ? 0 : 10 - remainder\r\n}\r\n\r\n/**\r\n * Genera un código de barras corto interno (6 dígitos)\r\n * Formato: contador secuencial simple a partir de 100001\r\n * Compatible con CODE128 en impresión de etiquetas\r\n */\r\nexport function generateBarcode(\r\n  _categoriaId: number,\r\n  secuencia: number\r\n): string {\r\n  // Base de 100000 para asegurar siempre 6 dígitos\r\n  const base = 100000\r\n  const codigo = base + secuencia\r\n  return codigo.toString()\r\n}\r\n\r\n/**\r\n * Obtiene la siguiente secuencia disponible para un producto\r\n * Esta función debe ser llamada desde el servidor con acceso a la BD\r\n */\r\nexport async function getNextSequence(\r\n  categoriaId: number,\r\n  tipoPrendaId: number,\r\n  tallaId: number\r\n): Promise<number> {\r\n  // Esta función debe implementarse en el API route\r\n  // Aquí solo definimos la estructura\r\n  return 1\r\n}\r\n\r\n/**\r\n * Valida un código de barras EAN-13\r\n */\r\nexport function validateEAN13(barcode: string): boolean {\r\n  if (barcode.length !== 13) return false\r\n  if (!/^\\d+$/.test(barcode)) return false\r\n  \r\n  const providedCheckDigit = Number.parseInt(barcode[12])\r\n  const calculatedCheckDigit = calculateEAN13CheckDigit(barcode.substring(0, 12))\r\n  \r\n  return providedCheckDigit === calculatedCheckDigit\r\n}\r\n\r\n/**\r\n * Formatea un SKU para mostrar\r\n */\r\nexport function formatSKU(sku: string): string {\r\n  return sku.toUpperCase()\r\n}\r\n\r\n/**\r\n * Genera una descripción corta para la etiqueta (máximo 30 caracteres)\r\n */\r\nexport function generateLabelDescription(\r\n  nombreProducto: string,\r\n  color: string | null,\r\n  talla: string\r\n): string {\r\n  let desc = nombreProducto.substring(0, 20)\r\n  if (color) {\r\n    desc += ` ${color.substring(0, 5)}`\r\n  }\r\n  desc += ` T:${talla}`\r\n  return desc.substring(0, 30)\r\n}\r\n"],"names":[],"mappings":"AAAA;;;;;;;CAOC,GAED;;CAEC;;;;;;;;;;;;;;;;AACM,SAAS,YACd,eAAuB,EACvB,gBAAwB,EACxB,WAAmB,EACnB,SAAiB;IAEjB,MAAM,YAAY,kBAAkB,iBAAiB,kBAAkB;IAEvE,0BAA0B;IAC1B,MAAM,UAAU,UAAU,QAAQ,GAAG,QAAQ,CAAC,GAAG;IAEjD,OAAO,GAAG,UAAU,CAAC,EAAE,SAAS;AAClC;AAKO,SAAS,kBACd,eAAuB,EACvB,gBAAwB,EACxB,WAAmB;IAEnB,yCAAyC;IACzC,MAAM,UAAU,gBAAgB,SAAS,CAAC,GAAG,GAAG,WAAW;IAE3D,kFAAkF;IAClF,IAAI,WAAW;IACf,MAAM,YAAY,iBAAiB,KAAK,CAAC;IACzC,IAAI,UAAU,MAAM,GAAG,GAAG;QACxB,+DAA+D;QAC/D,WAAW,UAAU,KAAK,CAAC,GAAG,GAAG,GAAG,CAAC,CAAA,IAAK,CAAC,CAAC,EAAE,EAAE,IAAI,CAAC,IAAI,WAAW;IACtE,OAAO;QACL,WAAW,iBAAiB,SAAS,CAAC,GAAG,GAAG,WAAW;IACzD;IAEA,0BAA0B;IAC1B,MAAM,YAAY,YAAY,WAAW,GAAG,OAAO,CAAC,OAAO;IAE3D,OAAO,GAAG,QAAQ,CAAC,EAAE,SAAS,CAAC,EAAE,WAAW;AAC9C;AAEA;;CAEC,GACD,SAAS,yBAAyB,IAAY;IAC5C,MAAM,SAAS,KAAK,KAAK,CAAC,IAAI,GAAG,CAAC;IAClC,IAAI,MAAM;IAEV,IAAK,IAAI,IAAI,GAAG,IAAI,IAAI,IAAK;QAC3B,OAAO,MAAM,CAAC,EAAE,GAAG,CAAC,IAAI,MAAM,IAAI,IAAI,CAAC;IACzC;IAEA,MAAM,YAAY,MAAM;IACxB,OAAO,cAAc,IAAI,IAAI,KAAK;AACpC;AAOO,SAAS,gBACd,YAAoB,EACpB,SAAiB;IAEjB,iDAAiD;IACjD,MAAM,OAAO;IACb,MAAM,SAAS,OAAO;IACtB,OAAO,OAAO,QAAQ;AACxB;AAMO,eAAe,gBACpB,WAAmB,EACnB,YAAoB,EACpB,OAAe;IAEf,kDAAkD;IAClD,oCAAoC;IACpC,OAAO;AACT;AAKO,SAAS,cAAc,OAAe;IAC3C,IAAI,QAAQ,MAAM,KAAK,IAAI,OAAO;IAClC,IAAI,CAAC,QAAQ,IAAI,CAAC,UAAU,OAAO;IAEnC,MAAM,qBAAqB,OAAO,QAAQ,CAAC,OAAO,CAAC,GAAG;IACtD,MAAM,uBAAuB,yBAAyB,QAAQ,SAAS,CAAC,GAAG;IAE3E,OAAO,uBAAuB;AAChC;AAKO,SAAS,UAAU,GAAW;IACnC,OAAO,IAAI,WAAW;AACxB;AAKO,SAAS,yBACd,cAAsB,EACtB,KAAoB,EACpB,KAAa;IAEb,IAAI,OAAO,eAAe,SAAS,CAAC,GAAG;IACvC,IAAI,OAAO;QACT,QAAQ,CAAC,CAAC,EAAE,MAAM,SAAS,CAAC,GAAG,IAAI;IACrC;IACA,QAAQ,CAAC,GAAG,EAAE,OAAO;IACrB,OAAO,KAAK,SAAS,CAAC,GAAG;AAC3B"}},
    {"offset": {"line": 209, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Oscar%20Llain/OneDrive/Documentos/VALVA/valva_boutique_pos/lib/db.ts"],"sourcesContent":["import mysql from 'mysql2/promise';\r\n\r\n// Configuración de la conexión a MySQL\r\nconst dbConfig = {\r\n  host: process.env.DB_HOST || 'localhost',\r\n  port: parseInt(process.env.DB_PORT || '3306'),\r\n  user: process.env.DB_USER || 'root',\r\n  password: process.env.DB_PASSWORD || 'Luciana1510@',\r\n  database: process.env.DB_NAME || 'valva_boutique',\r\n  waitForConnections: true,\r\n  connectionLimit: 10,\r\n  queueLimit: 0,\r\n  enableKeepAlive: true,\r\n  keepAliveInitialDelay: 0,\r\n};\r\n\r\n// Crear el pool de conexiones\r\nlet pool: mysql.Pool;\r\n\r\nexport function getPool(): mysql.Pool {\r\n  if (!pool) {\r\n    pool = mysql.createPool(dbConfig);\r\n  }\r\n  return pool;\r\n}\r\n\r\n// Función helper para ejecutar queries\r\nexport async function query<T = any>(\r\n  sql: string,\r\n  params?: any[]\r\n): Promise<T> {\r\n  const connection = await getPool().getConnection();\r\n  try {\r\n    const [results] = await connection.execute(sql, params);\r\n    return results as T;\r\n  } finally {\r\n    connection.release();\r\n  }\r\n}\r\n\r\n// Función helper para ejecutar queries con múltiples resultados\r\nexport async function queryMultiple<T = any>(\r\n  sql: string,\r\n  params?: any[]\r\n): Promise<T[]> {\r\n  const connection = await getPool().getConnection();\r\n  try {\r\n    const [results] = await connection.query(sql, params);\r\n    return results as T[];\r\n  } finally {\r\n    connection.release();\r\n  }\r\n}\r\n\r\n// Función para obtener una sola fila\r\nexport async function queryOne<T = any>(\r\n  sql: string,\r\n  params?: any[]\r\n): Promise<T | null> {\r\n  const results = await query<T[]>(sql, params);\r\n  return results.length > 0 ? results[0] : null;\r\n}\r\n\r\n// Función para ejecutar transacciones\r\nexport async function transaction<T>(\r\n  callback: (connection: mysql.PoolConnection) => Promise<T>\r\n): Promise<T> {\r\n  const connection = await getPool().getConnection();\r\n  try {\r\n    await connection.beginTransaction();\r\n    const result = await callback(connection);\r\n    await connection.commit();\r\n    return result;\r\n  } catch (error) {\r\n    await connection.rollback();\r\n    throw error;\r\n  } finally {\r\n    connection.release();\r\n  }\r\n}\r\n\r\n// Exportar tipos útiles\r\nexport type { PoolConnection, RowDataPacket, ResultSetHeader } from 'mysql2/promise';\r\n\r\n// Función para cerrar el pool (útil para testing)\r\nexport async function closePool(): Promise<void> {\r\n  if (pool) {\r\n    await pool.end();\r\n  }\r\n}\r\n\r\n// Función para verificar la conexión\r\nexport async function checkConnection(): Promise<boolean> {\r\n  try {\r\n    const connection = await getPool().getConnection();\r\n    await connection.ping();\r\n    connection.release();\r\n    return true;\r\n  } catch (error) {\r\n    console.error('Error al conectar con la base de datos:', error);\r\n    return false;\r\n  }\r\n}\r\n"],"names":[],"mappings":";;;;;;;;;;;;;;;;AAAA;;AAEA,uCAAuC;AACvC,MAAM,WAAW;IACf,MAAM,QAAQ,GAAG,CAAC,OAAO,IAAI;IAC7B,MAAM,SAAS,QAAQ,GAAG,CAAC,OAAO,IAAI;IACtC,MAAM,QAAQ,GAAG,CAAC,OAAO,IAAI;IAC7B,UAAU,QAAQ,GAAG,CAAC,WAAW,IAAI;IACrC,UAAU,QAAQ,GAAG,CAAC,OAAO,IAAI;IACjC,oBAAoB;IACpB,iBAAiB;IACjB,YAAY;IACZ,iBAAiB;IACjB,uBAAuB;AACzB;AAEA,8BAA8B;AAC9B,IAAI;AAEG,SAAS;IACd,IAAI,CAAC,MAAM;QACT,OAAO,kMAAK,CAAC,UAAU,CAAC;IAC1B;IACA,OAAO;AACT;AAGO,eAAe,MACpB,GAAW,EACX,MAAc;IAEd,MAAM,aAAa,MAAM,UAAU,aAAa;IAChD,IAAI;QACF,MAAM,CAAC,QAAQ,GAAG,MAAM,WAAW,OAAO,CAAC,KAAK;QAChD,OAAO;IACT,SAAU;QACR,WAAW,OAAO;IACpB;AACF;AAGO,eAAe,cACpB,GAAW,EACX,MAAc;IAEd,MAAM,aAAa,MAAM,UAAU,aAAa;IAChD,IAAI;QACF,MAAM,CAAC,QAAQ,GAAG,MAAM,WAAW,KAAK,CAAC,KAAK;QAC9C,OAAO;IACT,SAAU;QACR,WAAW,OAAO;IACpB;AACF;AAGO,eAAe,SACpB,GAAW,EACX,MAAc;IAEd,MAAM,UAAU,MAAM,MAAW,KAAK;IACtC,OAAO,QAAQ,MAAM,GAAG,IAAI,OAAO,CAAC,EAAE,GAAG;AAC3C;AAGO,eAAe,YACpB,QAA0D;IAE1D,MAAM,aAAa,MAAM,UAAU,aAAa;IAChD,IAAI;QACF,MAAM,WAAW,gBAAgB;QACjC,MAAM,SAAS,MAAM,SAAS;QAC9B,MAAM,WAAW,MAAM;QACvB,OAAO;IACT,EAAE,OAAO,OAAO;QACd,MAAM,WAAW,QAAQ;QACzB,MAAM;IACR,SAAU;QACR,WAAW,OAAO;IACpB;AACF;AAMO,eAAe;IACpB,IAAI,MAAM;QACR,MAAM,KAAK,GAAG;IAChB;AACF;AAGO,eAAe;IACpB,IAAI;QACF,MAAM,aAAa,MAAM,UAAU,aAAa;QAChD,MAAM,WAAW,IAAI;QACrB,WAAW,OAAO;QAClB,OAAO;IACT,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,2CAA2C;QACzD,OAAO;IACT;AACF"}},
    {"offset": {"line": 304, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Oscar%20Llain/OneDrive/Documentos/VALVA/valva_boutique_pos/app/api/productos/generar-codigos/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server'\r\nimport { generateSKU, generateSKUPrefix } from '@/lib/barcode-generator'\r\nimport { query } from '@/lib/db'\r\n\r\nexport async function POST(request: NextRequest) {\r\n  try {\r\n    const body = await request.json()\r\n    const { categoria_padre_id, tipo_prenda_id, talla_id } = body\r\n\r\n    // Obtener nombres desde la base de datos\r\n    const categoriaResult: any = await query(\r\n      \"SELECT nombre FROM categorias_padre WHERE id = ? AND estado = 'activo'\",\r\n      [categoria_padre_id]\r\n    )\r\n\r\n    const tipoPrendaResult: any = await query(\r\n      \"SELECT nombre FROM tipos_prenda WHERE id = ? AND estado = 'activo'\",\r\n      [tipo_prenda_id]\r\n    )\r\n\r\n    const tallaResult: any = await query(\r\n      \"SELECT valor FROM tallas WHERE id = ? AND estado = 'activo'\",\r\n      [talla_id]\r\n    )\r\n\r\n    if (!Array.isArray(categoriaResult) || categoriaResult.length === 0 ||\r\n        !Array.isArray(tipoPrendaResult) || tipoPrendaResult.length === 0 ||\r\n        !Array.isArray(tallaResult) || tallaResult.length === 0) {\r\n      return NextResponse.json(\r\n        { success: false, error: 'Datos no encontrados' },\r\n        { status: 404 }\r\n      )\r\n    }\r\n\r\n    const skuPrefix = generateSKUPrefix(\r\n      categoriaResult[0].nombre,\r\n      tipoPrendaResult[0].nombre,\r\n      tallaResult[0].valor\r\n    )\r\n\r\n    // Obtener la secuencia para el SKU (Ãºltimo nÃºmero + 1) usando el prefijo exacto\r\n    const secuenciaResult: any = await query(\r\n      `SELECT MAX(CAST(SUBSTRING_INDEX(sku, '-', -1) AS UNSIGNED)) as max_secuencia\r\n       FROM productos\r\n       WHERE sku LIKE CONCAT(?, '-%')\r\n         AND SUBSTRING_INDEX(sku, '-', -1) REGEXP '^[0-9]+$'`,\r\n      [skuPrefix]\r\n    )\r\n\r\n    const secuencia =\r\n      (Array.isArray(secuenciaResult) && secuenciaResult[0]?.max_secuencia\r\n        ? secuenciaResult[0].max_secuencia\r\n        : 0) + 1\r\n\r\n    // Obtener el Ãºltimo cÃ³digo de barras corto usado (6 dÃ­gitos mÃ¡ximo)\r\n    const ultimoCodigoResult: any = await query(\r\n      `SELECT CAST(codigo_barras AS UNSIGNED) as codigo_numero\r\n       FROM productos \r\n       WHERE codigo_barras REGEXP '^[0-9]{1,6}$'\r\n       ORDER BY CAST(codigo_barras AS UNSIGNED) DESC\r\n       LIMIT 1`\r\n    )\r\n\r\n    let nuevoCodigo: number\r\n    if (Array.isArray(ultimoCodigoResult) && ultimoCodigoResult.length > 0 && ultimoCodigoResult[0]?.codigo_numero) {\r\n      nuevoCodigo = Number(ultimoCodigoResult[0].codigo_numero) + 1\r\n    } else {\r\n      // Si no hay productos con cÃ³digo corto, empezar desde 100001\r\n      nuevoCodigo = 100001\r\n    }\r\n\r\n    // Generar cÃ³digos\r\n    const sku = generateSKU(\r\n      categoriaResult[0].nombre,\r\n      tipoPrendaResult[0].nombre,\r\n      tallaResult[0].valor,\r\n      secuencia\r\n    )\r\n\r\n    const codigo_barras = nuevoCodigo.toString()\r\n\r\nreturn NextResponse.json({\r\n      success: true,\r\n      sku,\r\n      codigo_barras,\r\n      secuencia\r\n    })\r\n\r\n  } catch (error) {\r\n    console.error('Error generando cÃ³digos:', error)\r\n    return NextResponse.json(\r\n      { success: false, error: 'Error interno del servidor' },\r\n      { status: 500 }\r\n    )\r\n  }\r\n}\r\n\r\n"],"names":[],"mappings":";;;;AAAA;AACA;AACA;;;;AAEO,eAAe,KAAK,OAAoB;IAC7C,IAAI;QACF,MAAM,OAAO,MAAM,QAAQ,IAAI;QAC/B,MAAM,EAAE,kBAAkB,EAAE,cAAc,EAAE,QAAQ,EAAE,GAAG;QAEzD,yCAAyC;QACzC,MAAM,kBAAuB,MAAM,IAAA,oHAAK,EACtC,0EACA;YAAC;SAAmB;QAGtB,MAAM,mBAAwB,MAAM,IAAA,oHAAK,EACvC,sEACA;YAAC;SAAe;QAGlB,MAAM,cAAmB,MAAM,IAAA,oHAAK,EAClC,+DACA;YAAC;SAAS;QAGZ,IAAI,CAAC,MAAM,OAAO,CAAC,oBAAoB,gBAAgB,MAAM,KAAK,KAC9D,CAAC,MAAM,OAAO,CAAC,qBAAqB,iBAAiB,MAAM,KAAK,KAChE,CAAC,MAAM,OAAO,CAAC,gBAAgB,YAAY,MAAM,KAAK,GAAG;YAC3D,OAAO,gRAAY,CAAC,IAAI,CACtB;gBAAE,SAAS;gBAAO,OAAO;YAAuB,GAChD;gBAAE,QAAQ;YAAI;QAElB;QAEA,MAAM,YAAY,IAAA,kJAAiB,EACjC,eAAe,CAAC,EAAE,CAAC,MAAM,EACzB,gBAAgB,CAAC,EAAE,CAAC,MAAM,EAC1B,WAAW,CAAC,EAAE,CAAC,KAAK;QAGtB,kFAAkF;QAClF,MAAM,kBAAuB,MAAM,IAAA,oHAAK,EACtC,CAAC;;;4DAGqD,CAAC,EACvD;YAAC;SAAU;QAGb,MAAM,YACJ,CAAC,MAAM,OAAO,CAAC,oBAAoB,eAAe,CAAC,EAAE,EAAE,gBACnD,eAAe,CAAC,EAAE,CAAC,aAAa,GAChC,CAAC,IAAI;QAEX,wEAAwE;QACxE,MAAM,qBAA0B,MAAM,IAAA,oHAAK,EACzC,CAAC;;;;cAIO,CAAC;QAGX,IAAI;QACJ,IAAI,MAAM,OAAO,CAAC,uBAAuB,mBAAmB,MAAM,GAAG,KAAK,kBAAkB,CAAC,EAAE,EAAE,eAAe;YAC9G,cAAc,OAAO,kBAAkB,CAAC,EAAE,CAAC,aAAa,IAAI;QAC9D,OAAO;YACL,8DAA8D;YAC9D,cAAc;QAChB;QAEA,mBAAmB;QACnB,MAAM,MAAM,IAAA,4IAAW,EACrB,eAAe,CAAC,EAAE,CAAC,MAAM,EACzB,gBAAgB,CAAC,EAAE,CAAC,MAAM,EAC1B,WAAW,CAAC,EAAE,CAAC,KAAK,EACpB;QAGF,MAAM,gBAAgB,YAAY,QAAQ;QAE9C,OAAO,gRAAY,CAAC,IAAI,CAAC;YACnB,SAAS;YACT;YACA;YACA;QACF;IAEF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,6BAA6B;QAC3C,OAAO,gRAAY,CAAC,IAAI,CACtB;YAAE,SAAS;YAAO,OAAO;QAA6B,GACtD;YAAE,QAAQ;QAAI;IAElB;AACF"}}]
}